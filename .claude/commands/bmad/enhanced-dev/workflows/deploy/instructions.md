# Deploy Workflow Instructions

Execute deployment pipeline: tests â†’ build â†’ optional git/server steps based on project setup.

## Steps

### 1. Project Detection & Setup

```yaml
Detect project capabilities:

1. Check for Git:
   - Run: git rev-parse --is-inside-work-tree
   - If exit code 0: Git detected
   - If exit code != 0: No git repository

   Store result: {has_git}

2. Ask user about deployment:
   Display: "ğŸ“¦ Deployment Setup"
   Display: "Git detected: {has_git}"

   Ask: "MÃ¶chtest du nach erfolgreichen Tests deployen?"
   Options:
     a) Nein, nur Tests ausfÃ¼hren
     b) Ja, zu lokalem Server/Service
     c) Ja, mit eigenem Deploy-Command

   Capture: {deploy_mode}

3. If deploy_mode = "b" or "c":
   Ask: "Welches Command soll ausgefÃ¼hrt werden?"
   Examples:
     - npm run build
     - npm run deploy
     - docker-compose up -d
     - vercel deploy --prod
     - ./deploy.sh

   Capture: {user_deploy_command}

4. If {has_git} = true:
   Ask: "Soll nach Deploy ein Git Commit erstellt werden?"
   Options:
     a) Nein
     b) Ja, committen und pushen
     c) Ja, nur committen (nicht pushen)

   Capture: {git_action}
```

### 2. Pre-Deployment Validation

```yaml
Check prerequisites:
  âœ“ Status file exists at {status_file}
  âœ“ If {has_git} = true: Check git status

Load status from {status_file}

Display summary:
  â†’ Tests will run
  â†’ Deployment: {deploy_mode}
  â†’ Git: {git_action if has_git, else "not available"}

Ask for confirmation: "Deployment starten?"
  If NO: Exit workflow
```

### 3. Run Full Test Suite

```yaml
Display: "ğŸ§ª Running tests..."

Execute {run_tests_command}

Capture:
  - All test results
  - Pass/fail counts
  - Coverage percentage (if available)
  - Test duration

Display results:
  âœ“ {passing_count} tests passing
  {if failing_count > 0}:
    âœ— {failing_count} tests failing
    Display failed test details

If {require_tests_pass} = true AND any tests fail:
  â†’ Display: "âŒ Deployment abgebrochen - Tests mÃ¼ssen erfolgreich sein"
  â†’ STOP workflow
  â†’ Exit with error

If {test_coverage_threshold} configured AND coverage < threshold:
  â†’ Display: "âš ï¸  Warning: Coverage {coverage}% unter Threshold {threshold}%"
  â†’ Ask: "Trotzdem fortfahren?"
    If NO: STOP workflow

Display: "âœ… Alle Tests erfolgreich"
```

### 4. Build Step (if configured)

```yaml
If {pre_deploy_command} configured:
  Display: "ğŸ”¨ Building..."

  Execute {pre_deploy_command}

  Capture output

  If fails:
    â†’ Display: "âŒ Build fehlgeschlagen"
    â†’ Display build errors
    â†’ STOP workflow

  Display: "âœ… Build erfolgreich"
```

### 5. Deployment (based on user choice)

```yaml
If {deploy_mode} = "a" (Nur Tests):
  â†’ Skip to Step 7 (Update Status)

If {deploy_mode} = "b" or "c":
  Display: "ğŸš€ Deploying..."

  Execute {user_deploy_command}

  Track:
    - Deploy start time: {deploy_start}
    - Deploy output
    - Deploy status

  If fails:
    â†’ Display: "âŒ Deployment fehlgeschlagen"
    â†’ Display error output
    â†’ Ask: "Trotzdem Git Commit erstellen?" (if {has_git})
    â†’ Update status: deploy_failed
    â†’ STOP workflow (or continue to git if user confirms)

  Track deploy end time: {deploy_end}
  Calculate duration: {deploy_duration}

  Display: "âœ… Deployment erfolgreich ({deploy_duration})"
```

### 6. Git Operations (if applicable)

```yaml
If {has_git} = true AND {git_action} != "a" (not "Nein"):

  Display: "ğŸ“ Git Operations..."

  1. Stage changes:
     git add .

  2. Create commit:
     Message format:
     "deploy: automated deployment

     - Tests: {passing_count} passing
     {if coverage}: - Coverage: {coverage}%
     {if deploy_mode != "a"}: - Deployed: {deploy_status}

     ğŸ¤– Generated by Enhanced Dev"

     Execute: git commit -m "{message}"

  3. Capture commit hash: {commit_hash}

  Display: "âœ… Commit created: {commit_hash}"

  4. If {git_action} = "b" (committen und pushen):
     Display: "â¬†ï¸  Pushing to remote..."

     Get current branch: git branch --show-current â†’ {current_branch}
     Get remote: git remote â†’ {remote} (usually "origin")

     Execute: git push {remote} {current_branch}

     If fails:
       â†’ Display: "âŒ Git push fehlgeschlagen"
       â†’ Display common fixes:
         - git pull --rebase
         - Check network connection
         - Check permissions
       â†’ Commit exists locally but not pushed
       â†’ Exit with warning

     Display: "âœ… Pushed to {remote}/{current_branch}"
```

### 7. Update Status

```yaml
Write to {status_file}:

  last_deploy:
    timestamp: "{current_timestamp}"
    tests_passed: {all_tests_passed}
    {if coverage}: coverage: {coverage}%
    {if deploy_mode != "a"}:
      deployed: true
      deploy_status: "{success/failed}"
      deploy_command: "{user_deploy_command}"
    {if has_git and git_action != "a"}:
      git_commit: "{commit_hash}"
      {if git_action = "b"}:
        git_pushed: true
        git_branch: "{current_branch}"

  validation:
    ready_for_deploy: false  # Reset
```

### 8. Final Report

```yaml
Display in {communication_language}:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‰ Deployment Abgeschlossen
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Tests:
  âœ“ {passing_count} passing
  {if failing_count > 0}: âœ— {failing_count} failing
  {if coverage}: ğŸ“ˆ Coverage: {coverage}%
  â±ï¸  Duration: {test_duration}

{if pre_deploy_command}:
  Build:
    âœ“ Build erfolgreich
    â±ï¸  Duration: {build_duration}

{if deploy_mode != "a"}:
  Deployment:
    {deploy_status_icon} {deploy_status}
    Command: {user_deploy_command}
    â±ï¸  Duration: {deploy_duration}

{if has_git and git_action != "a"}:
  Git:
    ğŸ“ Commit: {commit_hash}
    {if git_action = "b"}: â¬†ï¸  Pushed to {remote}/{branch}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{if any warnings or issues}:
  âš ï¸  Hinweise:
  {list warnings}

âœ… Alles erledigt!
```

## Error Handling

### Test Failures

```yaml
If tests fail AND {require_tests_pass} = true:
  Display:
    âŒ Tests fehlgeschlagen

    Fehlgeschlagene Tests:
    {list failed tests with details}

    Empfehlung:
    â†’ Fehler beheben
    â†’ Tests erneut ausfÃ¼hren
    â†’ Erst dann deployen

  Exit workflow with error code 1
```

### Build Failures

```yaml
If build fails:
  Display:
    âŒ Build fehlgeschlagen

    Error:
    {build error output}

    HÃ¤ufige Ursachen:
    â†’ Fehlende Dependencies
    â†’ Syntax-Fehler
    â†’ Konfigurationsprobleme

    Empfehlung:
    â†’ Error beheben
    â†’ Build lokal testen
    â†’ Workflow erneut starten

  Exit workflow with error code 1
```

### Deployment Failures

```yaml
If deployment fails:
  Display:
    âŒ Deployment fehlgeschlagen

    Error:
    {deploy error output}

    Status:
    â†’ Tests waren erfolgreich
    â†’ Build war erfolgreich
    â†’ Deployment ist fehlgeschlagen

  Ask: "Git Commit trotzdem erstellen (Tests + Build waren ok)?"
    If YES: Continue to git operations
    If NO: Exit workflow
```

## Configuration

The workflow uses these variables from workflow.yaml:

```yaml
# Required
run_tests_command: "npm test"  # Command to run tests
status_file: "{project-root}/bmad/enhanced-dev/status.yaml"

# Optional
require_tests_pass: true  # Stop if tests fail
test_coverage_threshold: 80  # Warn if coverage below this
pre_deploy_command: ""  # Build command (detected or asked)

# Runtime (asked during workflow)
deploy_mode: "a/b/c"  # User choice
user_deploy_command: ""  # User input if deploying
git_action: "a/b/c"  # User choice if git available
```

## Best Practices

1. **Always run tests**: Never skip test validation
2. **Review before deploy**: Check what will be deployed
3. **Monitor after deploy**: Watch for errors
4. **Commit meaningful changes**: Tests + working code

## Communication

Communicate in {communication_language}

Display clear status at each step with icons:
- ğŸ§ª Tests
- ğŸ”¨ Build
- ğŸš€ Deploy
- ğŸ“ Git
- âœ… Success
- âŒ Error
- âš ï¸  Warning
